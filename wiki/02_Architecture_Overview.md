# 系统架构

本文档描述ProjectGeodesy的整体系统架构、技术栈和数据流。

---

## 📋 目录

- [系统概述](#系统概述)
- [硬件架构](#硬件架构)
- [软件架构](#软件架构)
- [数据流](#数据流)
- [技术栈](#技术栈)
- [关键算法](#关键算法)

---

## 系统概述

### 目标

开发一套**固定基座智能拧紧机器人系统**，用于汽车制造（如蔚来前顶板装配），实现高精度自动螺丝拧紧。

### 核心特点

- **3D视觉定位** - ICP点云配准，适应工件随机放置
- **视觉伺服** - IBVS精对准，精度 <0.5mm
- **AI任务规划** - LLM动态生成行为树
- **柔顺力控** - 螺旋搜索 + 阻抗控制

### 应用场景

- 汽车制造（13个螺丝孔）
- 3C产品装配
- 精密零部件组装

---

## 硬件架构

### 硬件组成

```
┌─────────────────────────────────────────────────────────┐
│                    计算平台                              │
│  ┌────────────────┐            ┌──────────────────────┐ │
│  │ Jetson AGX Orin │            │   工控机             │ │
│  │  (边缘推理)      │  ← 千兆网 →  │ RTX 5090 + i9      │ │
│  │  ROS 2 Core     │            │   视觉处理          │ │
│  └────────────────┘            └──────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        ↓                 ↓                 ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  MecMind Pro │  │ MecMind Nano │  │  天机Marvin  │
│  (头顶相机)   │  │ (手腕相机)    │  │  机械臂      │
│  粗定位      │  │ 精对准        │  │  上半身       │
└──────────────┘  └──────────────┘  └──────────────┘
                                              │
                                    ┌───────────┴───────────┐
                                    ↓                       ↓
                              ┌──────────┐          ┌──────────┐
                              │ Atlas    │          │ 自动送钉 │
                              │ 电枪     │          │ 机       │
                              └──────────┘          └──────────┘
```

### 硬件规格

| 组件 | 型号 | 参数 |
|------|------|------|
| **计算核心** | Jetson AGX Orin | 64GB, 205TOPS |
| **工控机** | RTX 5090 + i9 | 64-128GB DDR5 |
| **机械臂** | 天机 Marvin 上半身 | 7自由度 |
| **3D相机** | MecMind Pro/Nano | 深度精度0.1mm |
| **拧紧枪** | Atlas Copco | 直柄电枪 |

---

## 软件架构

### 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                  决策层 (Decision Layer)                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ LLM Planner → BT Compiler → Behavior Tree Executor   │  │
│  │ 输入：工件状态 → 输出：拧紧序列 → 执行：动作编排     │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                   技能层 (Skill Layer)                       │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │GlobalAlign  │ ApproachMove│ VisualServo │  ScrewIn    │ │
│  │全局粗定位   │进场轨迹规划 │视觉伺服精对准│螺旋入孔+拧紧│ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                  感知层 (Perception Layer)                   │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │ PointCloud  │ HoleDetect  │ PoseEstimate│ IBVS        │ │
│  │ ICP配准     │ Yolo/Blob   │ 6DoF位姿    │ 图像反馈    │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                  控制层 (Control Layer)                      │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │SpiralSearch │ Impedance   │ MoveIt      │ Collision   │ │
│  │螺旋搜索入孔 │阻抗控制拧紧 │轨迹规划     │碰撞检测     │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                硬件接口层 (Hardware Interface)               │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│  │Robot Driver │ Camera SDK  │ Gun Driver  │ Safety IO   │ │
│  │机械臂驱动   │相机SDK      │拧紧枪驱动   │安全IO      │ │
│  └─────────────┴─────────────┴─────────────┴─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                      ROS 2 Middleware                       │
│                    (Topics + Services + Actions)             │
└─────────────────────────────────────────────────────────────┘
```

### 核心模块

#### 1. 决策层

**LLM任务规划**
- 输入：工件状态（遮挡、可达性等）
- 输出：最优拧紧序列
- 模型：Qwen 2.5 7B / GPT-4
- 格式：JSON序列

**行为树执行**
- 节点类型：Sequence, Selector, Action, Condition
- 编译器：JSON → BT XML
- 引擎：BehaviorTree CPP

#### 2. 感知层

**全局定位**
- 算法：PCA粗配准 + ICP精配准
- 输入：工件点云
- 输出：4x4变换矩阵
- 精度：<2mm

**孔位检测**
- 方法：YOLOv8 / Blob Detection
- 输入：手腕相机图像
- 输出：孔位2D/3D坐标

#### 3. 控制层

**螺旋搜索**
- 策略：XY平面螺旋 + Z轴监测
- 触发：Z轴"掉落"判断入孔成功

**阻抗控制**
- 柔顺拧紧，保护塑料件
- 力矩监控，异常处理

---

## 数据流

### 完整工作流

```
┌─────────────────────────────────────────────────────────────┐
│ Phase 1: 示教（一次）                                       │
└─────────────────────────────────────────────────────────────┘
  标准件 → MecMind Pro → 点云采集 → 人工标注 → 模板保存
                              ↓
                        13个孔位坐标

┌─────────────────────────────────────────────────────────────┐
│ Phase 2: 全局定位（每工件一次）                             │
└─────────────────────────────────────────────────────────────┘
  工件 → 相机 → 点云 → 预处理 → PCA粗配准 → ICP精配准
                                    ↓
                            4x4变换矩阵T

┌─────────────────────────────────────────────────────────────┐
│ Phase 3: 任务规划（每工件一次）                             │
└─────────────────────────────────────────────────────────────┘
  工件状态 → LLM分析 → 拧紧序列 → BT编译 → 行为树

┌─────────────────────────────────────────────────────────────┐
│ Phase 4: 逐孔拧紧（循环13次）                               │
└─────────────────────────────────────────────────────────────┘
  For each hole:
    生成进场位姿 → MoveIt规划 → IBVS精对准 → 螺旋入孔 → 阻抗拧紧
                       ↓                    ↓
                   <0.5mm误差        成功判定
```

### ROS 2话题

| 话题 | 类型 | 方向 | 说明 |
|------|------|------|------|
| `/camera/pointcloud2` | sensor_msgs/PointCloud2 | 订阅 | 相机点云 |
| `/perception/transformation` | std_msgs/Float64Array | 发布 | 4x4变换矩阵 |
| `/perception/hole_positions` | geometry_msgs/PoseArray | 发布 | 孔位坐标 |
| `/perception/alignment_status` | std_msgs/String | 发布 | 配准状态 |
| `/robot/command` | trajectory_msgs/... | 发布 | 机械臂指令 |
| `/robot/feedback` | sensor_msgs/JointState | 订阅 | 关节反馈 |

---

## 技术栈

### 软件

| 分类 | 技术 | 用途 |
|------|------|------|
| **机器人框架** | ROS 2 Humble | 中间件 |
| **运动规划** | MoveIt 2 | 轨迹规划 |
| **点云处理** | Open3D 0.19 | 配准算法 |
| **图像检测** | YOLOv8 / OpenCV | 孔位检测 |
| **行为树** | BehaviorTree CPP | 任务编排 |
| **大模型** | Qwen 2.5 / GPT-4 | 任务规划 |
| **仿真** | Isaac Sim | 虚拟测试 |
| **UI** | PyQt6 | 示教界面 |

### 语言

- **C++** - 性能关键模块（控制、规划）
- **Python** - 算法开发、测试、原型

---

## 关键算法

### 1. 点云配准

**流程**:
```
输入点云 → 体素滤波 → 去噪 → PCA粗配准 → ICP精配准 → 变换矩阵
```

**参数**:
- 体素大小：5mm
- ICP对应距离：20mm
- 收敛精度：<2mm RMS

### 2. 视觉伺服 (IBVS)

**原理**:
```
图像特征 → 像素误差 → PID控制 → 机器人运动 → 收敛
```

**目标**:
- 孔位对准误差 <0.5mm
- 控制频率 30-50Hz

### 3. 螺旋搜索

**策略**:
```
初始位置 → XY平面螺旋运动 → 监测Z轴 → 掉落检测 → 入孔成功
```

**参数**:
- 螺旋半径：0.5-2mm
- Z轴掉落阈值：3-5mm

---

## 性能指标

### 设计目标

| 指标 | 目标 | 当前状态 |
|------|------|---------|
| 配准精度 | <2mm | ✅ 0.85mm |
| 配准时间 | <600ms | ✅ ~270ms |
| 视觉伺服精度 | <0.5mm | 🚧 测试中 |
| 拧紧成功率 | >95% | 🚧 测试中 |
| 节拍时间 | TBD | 📋 待定义 |

---

## 扩展性

### 模块化设计

- 每层独立开发和测试
- 标准化ROS 2接口
- 可插拔算法（如YOLOv8 ↔ Blob Detection）

### 多机器人支持

- 当前：单臂
- 未来：双臂协作
- 扩展：多工位并行

---

**下一步**: [开发路线图](03_Development_Roadmap.md) →
